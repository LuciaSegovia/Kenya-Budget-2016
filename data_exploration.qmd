---
title: "Deliverable X. Report on the framework to include School Feeding Programme contribution to inadequacy estimates when using Household Consumption and Expenditure Surveys."
format: html
editor: Source
---

# Introduction

1.School Feeding programmes are the single most extensive social protection programe in the world covering more than 4M of children worldwide.

2. HCES data provide good insides on micronutrient inadequacies at national and subnational levels when other dietary data are not available.

3. One issue with HCES is accounting for the contribution of School Feeding (SF) which in some countries can reach high number of School Age Children (SAC). 


# Methods

1. Adaptation of AFE to SAC, steps 1.1 is common to any of the Household Allocation system (AME, AFE, etc). 

1.1. Calculating the Energy requirements of all household members using the function `Enerc_requirements()`. This is based on the data provided in the roster. The information needed is: Age, Sex, and Weight. When weights are not provided, the weight are assumed as follow:

0-10: WHO, P50. This assumption can be change in the function ``.
10-18: WHO, P50. This assumption can be change in the function ``.
18-+60: DHS, . This assumtion is country specific and should be provided by the user in the function ``.

Additional energy requirement for pregnancy and lactating women are based on US Guidelines 2022-2025 (See @table 5-2).

Table 5-2. Estimated Change in Calorie Needs During Pregnancy and Lactation for Women With a Healthy Prepregnancy Weight

| Stage of Pregnancy or Lactation | Estimated Change in Daily Calorie Needs Compared to Prepregnancy Needs|
|---|---|
|Pregnancy: 1st trimester | + 0 calories |
|Pregnancy: 2nd trimester | + 340 calories |
|Pregnancy: 3rd trimester | + 452 calories |
|Lactation: 1st 6 months | + 330 caloriesb |
|Lactation: 2nd 6 months | + 400 caloriesc |


1.2. Adaptation of the Energy requirement based on who's eating and the proportion of food eaten using the funcion `Enerc_adjustments()`. Here, the most important is the reduced contribution due to breasfeeding.

1. Exclusive breastfeeding [0-3 months] = 0 kcal
2. Non-Exclusive breastfeeding [4-23 months] = -(380-478) kcal

Then, we need to adjust the probablity of being breastfed (BF) based on each country.

We considered up to 3months exclusive breastfeeding even it is not true, due to the very small quantities that the energy contribution from the whole household. 

We used information on DHS, 2022. 


## Data sources

There are few household surveys in Kenya wit good food item information. However, the most recent is smaller in number of households, and it also provided less information regarding the school feeding. 

We could combine the information of both surveys to strenghtening the resuts.

Also, there is no GIS information in any, although for the most recent, the KENYA CONTINUOUS HOUSEHOLD SURVEY PROGRAMMME (2020 KCHS), in the survey manual and questionaire, GPS coordenates (lon/lat) were collected.  


## Individual data exploration



```{r}
#install.packages("anthro")
#library(anthro)
library(dplyr)
library(ggplot2)
library(sf) # spatial data manipulation
library(tmap) # spatial data viz

# Data
# GIS data
ken_admin2 <- st_read(here::here("data", "gis", "KEN", "AgroMaps", "Africa", "shapefiles",
                           "KEN", "admin2", "ken.shp"))

ken_admin2 <- ken_admin2 %>%
  mutate(county_name = stringr::str_to_title(NAME2_), 
         county_name = case_when(
  county_name == "E. Marakwet" ~ "Elgeyo/Marakwet", 
  county_name == "Homa_bay" ~ "Homa Bay", 
  county_name == "Muranga" ~ "Murang'a", 
  county_name == "Nairobi" ~ "Nairobi City", 
  county_name == "Taita Taveta" ~ "Taita/Taveta", 
  county_name == "Nithi" ~ "Tharaka-Nithi", 
  county_name == "Trans-Nzoia" ~ "Trans Nzoia", 
  .default = county_name))


head(ken_admin2)

# Household info
hh <- haven::read_dta(here::here("data",  "HH_Information.dta"))
# Roster info
roster <- haven::read_dta(here::here("data", "HH_Members_Information.dta")) %>%
  rename(
         lineNum = "b01", 
         sex = "b04", 
         age_y = "b05_yy", 
         age_m = "b05_mm", 
         school = "c03", # attended to school
         school_lastyear = "c07", # attended school during the last school/academic year
         school_km = "c04", 
         school_feed = "c05",
         school_level = "c06_l", 
         school_grade = "c06_g", 
         drop_reason1 = "c09_r1",
         drop_reason2 = "c09_r2",
         school_feed_shill = "c13_o",
         sickness1 = "e03_1", # 26 pregnancy related
         sickness2 = "e03_2", # 26 pregnancy related
         weight_kg = "f21", 
         height_cm = "f22"
         ) %>% # generating a unique hhid
mutate(bmi = weight_kg/((height_cm/100)^2), 
  hhid_unique = paste(clid, hhid, sep = "_"), 
  id_unique = paste(clid, hhid,lineNum, sep = "_")) %>% 
  relocate( c(hhid_unique,id_unique), .before = "clid") %>% 
  left_join(., hh %>% select(county, resid, clid, hhid))

# Extracting the county name from the stata label
roster$county_name <- as.character(forcats::as_factor(roster[["county"]]))

# Data from F&D Domain
data <- read.csv(here::here("data", "FAOSTAT_data_en_6-17-2025.csv"))
str(data)
unique(data$Geographic.Level)

# Crop data 
# Reading csv (lon(x)/lat(y))
crop <- read.csv(here::here("data", "spam2017V2r1_SSA_Y_TA.csv")) %>% 
  dplyr::filter(iso3 == "KEN") %>% st_as_sf(.,  coords = c("x", "y"))

crop_names <- read.csv(here::here("data", "crop_names.csv")) 

# School info
edu <- st_read("data/gis/05_Educational_Centers_AGGREGATION_EPSG4326_2024_06_17_CEAT.gpkg")
edu <- edu %>% filter(iso3code == "KEN")
head(edu)

```


###  Age

Children age 6–13 for primary school and children age 14–17
for secondary school

```{r}

# Checking for missing values
sum(is.na(roster$age_y)) # Age

hist(roster$age_y)
sum(roster$age_y>200)
roster$age_y[roster$age_y>200] # Sounds like NA (98	Age not known; 99	Age not stated)
roster$age_y[roster$age_y>200] <- NA
roster$age_m[is.na(roster$age_y)]
sum(is.na(roster$age_m))

#roster$sex <- as.character(roster$sex)

#create population pyramid
roster %>% group_by(age_y, sex) %>% 
  summarise(population = n()) %>% 
  mutate(sex = as.character(sex)) %>% 
ggplot(aes(x = age_y, fill = sex,
                 y = ifelse(test = sex == "1",
                            yes = -population, no = population))) + 
  geom_bar(stat = "identity") +
#  scale_y_continuous(labels = abs, limits = max(roster$population) * c(-1,1)) +
  coord_flip()

```

#### Age group categories

For easy manipulation, we are creaing a few age categories.

```{r}
# Creating a dummy for age groups
roster <- roster %>% 
  mutate(age_group = case_when(
    age_y<=2 ~ "infant", 
    age_y >2  & age_y < 6 ~ "preschool" ,
    age_y >=6 & age_y <= 13 ~ "primary school", 
    age_y>=14 & age_y <=17 ~ "secondary school", 
    age_y >17 & age_y <= 49 ~ "adult", 
    age_y>49 ~ "eldery", 
    TRUE ~ NA ), 
    across(sex, as.factor))

roster %>% 
  ggplot(aes(reorder(age_group, age_y), age_y, fill = sex)) + geom_boxplot()

```


Number of children in school age?

```{r}

length(unique(roster$hhid_unique))
length(unique(roster$clid))

# No. of HH w/children in school age? 
(roster_sac <- length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <17])))
# Perc. of HH w/children in school age? ~50%
length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <17]))/length(unique(roster$hhid_unique))


```


Let's now see wether the distribution across the country is similar

```{r}
names(roster)
grep("feed", labelled::var_label(roster), ignore.case = TRUE, value = TRUE)

tmap_mode("view")
roster %>% # filter(age_group == "primary school") %>% 
  group_by(county, county_name,  age_group) %>% 
  mutate(count = length(id_unique)) %>% select(county, county_name, age_group, count) %>% distinct() %>%  ungroup() %>% 
  group_by(county, county_name) %>% 
  mutate(per = count/sum(count)*100) %>% 
  filter(age_group == "primary school") %>%
  left_join(., ken_admin2) %>% 
  # filter(is.na(geometry))
  # class
  st_as_sf() %>% 
  tm_shape() +
  tm_polygons(fill = "count",
               fill.scale = tm_scale_intervals(breaks = c(200,400,600,800, 1000)),
              fill_alpha = 0.5) +
  tm_shape(edu %>% filter(category == "primary")) +
  tm_symbols(size = "student_per_school", 
             size.scale = tm_scale_intervals(values = c(0.3,0.5, 0.8, 1.2), # value.na = 0.1,
                         breaks = c(1,150,300,450,600, 171945)), 
             fill = "student_per_school",
            fill.scale = tm_scale_intervals(values =palette7,  breaks = c(1,150,300,450,600, 171945)), 
            size.legend = tm_legend_combine("fill"), 
            options = opt_tm_labels(remove_overlap = FALSE)) 

```


### School attendance & feeding 


```{r}

# Perc. of HH w/children in school age with at least 1 going to school? ~95%
length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <17 & roster$school == 1]))/roster_sac

# Perc. of HH w/children in school age with at least 1 going to school? ~28%
length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <17 & roster$school == 1  & roster$school_feed == 1]))/length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <17 & roster$school == 1]))


# Perc. of HH w/children in primary with at least 1 going to school? ~25%
length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <13 & roster$school == 1  & roster$school_feed == 1]))/length(unique(roster$hhid_unique[roster$age_y>6 & roster$age_y <13 & roster$school == 1]))

# Perc. of HH w/children in seconday with at least 1 going to school? ~28%
length(unique(roster$hhid_unique[roster$age_y>13 & roster$age_y <17 & roster$school == 1  & roster$school_feed == 1]))/length(unique(roster$hhid_unique[roster$age_y>13 & roster$age_y <17 & roster$school == 1]))

```


Checking levels, grades and age of children attanding the school.

```{r}

# Checking recoded 
length(roster$school_level[roster$school_level>90 & !is.na(roster$school_level)])
#roster$school_level[roster$school_level>90 & !is.na(roster$school_level)] <- NA

haven::print_labels(roster$school_level)

# Primary school
roster %>% 
  filter(age_y>6 & 
    age_y <14) %>% 
  filter(school == 1) %>% 
#  filter(age_y > 100) %>% View() 
#  select(rosterid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, height_clean, weight_clean, bmi ) #%>% View()
  ggplot(aes(as.factor(school_level), age_y, colour =as.factor(school_grade))) + geom_boxplot()

tmap_mode("plot")
tm_shape(World) +
  tm_polygons()

```

In general, we can see a increase trend with school level, grade and age. Although, we can assume that some of the data may be rongly recoded. Eg., some SAC recoded as secondary or university udergrads. It is likely that the level was recorded as grade and vice versa. As, they were mostly recorded as grade one and two. 

If we are going to use this variables, we should recode some of the entries. 

```{r}

# Primary school
roster %>% 
  filter(age_y>6 & 
    age_y <14) %>% 
  filter(school == 1) %>% 
#  filter(age_y > 100) %>% View() 
#  select(hhid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, height_clean, weight_clean, bmi ) #%>% View()
  ggplot(aes(as.factor(school_level), colour =as.factor(school_feed))) + geom_density() + facet_wrap(~school_level)

# No. of SAC (primary only)
N_sac <- length(roster$id_unique[roster$age_y>6 & roster$age_y <14])

# Primary school - school feeding
roster %>% 
  filter(age_y>6 & 
    age_y <14) %>% 
#  filter(school == 1) %>% 
  group_by(school, school_feed) %>% 
  summarise(count = round(n()/N_sac*100))


```

The number of children enrolled in shool and receiving (ot at least attending to a school which provide school feeding) are in line but slightly higher than those reported in the Country profile (GCNF, 2019). 

```{r}

# No. of SAC attending schools w/ SFP
N_sac_feed <- length(roster$id_unique[roster$age_y>6 & roster$age_y <14 & !is.na(roster$school_feed) &  roster$school_feed == 1])

# Primary school - school feeding by sex
roster %>% 
  filter(age_y>6 & 
    age_y <14) %>% 
 filter(school_feed == 1) %>% 
  group_by(sex) %>% 
  summarise(count = round(n()/N_sac_feed*100))
```


Regarding the sex split for children receiving school feeding, here, was a bit more balanced (although this is not accounting for the survey design). 



#### Expending on school feeding (c13_o)

Interestingly, there is spending in SFP on non-school attendant... The main reason is likely to be that the question asking for spending on the past year. Hence, when combining current attendance & last year attendance, then we can see that spending above 0 are for only attending children. 


```{r}

roster %>% 
  mutate(school_pastyear = ifelse(school == 1 | school_lastyear == 1, 1, 2)) %>% 
  filter(school_feed_shill >0 ) %>% 
  ggplot(aes( as.factor(school_pastyear), school_feed_shill,  colour =as.factor(school_feed))) + geom_boxplot()

```


```{r}

ids <- roster %>% 
   filter(school == 2) %>% 
  filter(school_feed_shill >0 )  %>% # View() 
 select(hhid_unique, lineNum, age_y, age_m, sex, school, school_feed_shill) %>% pull(hhid_unique)

roster %>% filter(hhid_unique %in% ids) %>% select(hhid_unique, lineNum, age_y, age_m, sex, school,school_lastyear , drop_reason1, drop_reason2, school_feed_shill) %>% View()

  #ggplot(aes(as.factor(school), age_y, colour =as.factor(school_feed))) + geom_boxplot()
  ggplot(aes( as.factor(school), school_feed_shill,  colour =as.factor(school_feed))) + geom_boxplot()

```


### Anthroprometry

There is an R package from WHO that can be used to calculate and check anthro data for <5 yo `install.packages("anthro")`. 



#### Weight 

Checking the weight by age categories, we can see that the medians look fine but the spread is off. There are SAC with >100Kg of weight, which is unlikely, specially for primary school children.


```{r}

roster %>% 
  ggplot(aes(reorder(age_group, weight_kg), weight_kg, fill = sex)) + geom_boxplot()

# 
roster %>%
  mutate(age_group = factor(age_group, c("infant", "preschool", "primary school", "secondary school", "adult", "eldery"))) %>% 
  ggplot(aes( weight_kg, fill = sex)) + 
  geom_histogram(binwidth = 2) + #coord_flip()+
  facet_wrap(~age_group)

```

For infants anything above 20Kg should be suspicious...As according to WHO standards 3SD for 2yo is 17Kg. There seems to be multiple issues, I think the easier would be to look at them base on the age/sex table we have, and flag those above the percentails and look at them individually. 


```{r}

roster %>% filter(weight_clean>20 & age_y<2) %>% select(hhid_unique, lineNum,  age_y, age_m, sex, weight_kg, weight_clean, height_cm ) %>% 
  arrange(age_y)

roster %>% filter(weight_clean>40 & age_y<5) %>% select(hhid_unique, lineNum,  age_y, age_m, sex, weight_kg, weight_clean, height_cm ) %>% 
  arrange(age_y)

roster <- roster %>% mutate(
  weight_clean = case_when(
  (weight_kg>40 & age_y<2) |(weight_kg>100 & age_y<6) ~ weight_kg/10, # Wrong unit
  # Wrong column
    weight_kg>100 & age_y>6 & age_y<20 ~ height_cm, 
    weight_kg>80 & age_y<5 & height_cm<100 ~ height_cm,
 #   weight_kg>80 & age_y<5 & height_cm>100 ~ height_cm/10, # Wrong column & unit
    TRUE ~ weight_kg
  ),
  height_clean = case_when(
    weight_kg>100 & age_y>6 & age_y<20 ~ weight_kg, 
    weight_kg>80 & age_y<5 ~ weight_kg,
    height_cm<100 & age_y>6 & grepl("^1", height_cm) ~ height_cm*10,
    TRUE ~  height_cm
  )
)

roster %>% filter(weight_clean>100 & age_y<20) %>% select(hhid_unique, age_y, age_m, sex, weight_kg, height_cm ) %>% 
  arrange(age_y)

# Checking special cases ("307_9", "581_5", "1966_7")
roster %>% filter(hhid_unique == "581_5") %>% select(hhid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, bmi ) 

# Checking special cases ("307_9", "581_5", "1966_7")
roster %>% filter(hhid_unique == "307_9") %>% select(hhid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, bmi ) 

# Wrong - copied line above (12yo brother info)
roster$height_clean[roster$hhid_unique == "307_9" & roster$lineNum == "5"] <- NA
roster$weight_clean[roster$hhid_unique == "307_9" & roster$lineNum == "5"] <- NA

# Checking special cases ("1966_7")
roster %>% filter(hhid_unique == "1966_7") %>% select(hhid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, bmi ) 

# Wrong - swapped sibilings info (8 and 1yo sibilings info)
roster$height_clean[roster$hhid_unique == "1966_7" & roster$lineNum == "2"] <- 123.2
roster$weight_clean[roster$hhid_unique == "1966_7" & roster$lineNum == "2"] <- 23.2
roster$height_clean[roster$hhid_unique == "1966_7" & roster$lineNum == "3"] <- 76.4
roster$weight_clean[roster$hhid_unique == "1966_7" & roster$lineNum == "3"] <- 7.2

```

For household `"1966_7"`, they recorded the height and weight on the wrong child, so the information is reverted. The rest of the information seems fine....

#### Height 

```{r}

roster %>% filter(height_cm<100 & age_y>6 & age_y<15 & grepl("^2|^3", height_clean)
              ) %>% select(hhid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, height_clean) %>% 
  arrange(age_y)

# Specific case (weight & height reverted)
roster$height_clean[roster$hhid_unique == "495_6" & roster$lineNum == "2"] <- 116.2	
roster$weight_clean[roster$hhid_unique == "495_6" & roster$lineNum == "2"] <- 19.5
# Specific case (weight & height reverted)
roster$height_clean[roster$hhid_unique == "1750_3" & roster$lineNum == "5"] <- 151.2	
roster$weight_clean[roster$hhid_unique == "1750_3" & roster$lineNum == "5"] <- 38.7


roster$height_clean[roster$height_cm<100 & roster$age_y>6 & roster$age_y<15 & grepl("^2|^3", roster$height_clean)] <- roster$height_clean[roster$height_cm<100 & roster$age_y>6 & roster$age_y<15 & grepl("^2|^3", roster$height_clean)]+100

roster$height_clean[roster$hhid_unique == "1374_9" & roster$lineNum == "4"] <- 158.1	
```

 Checking the changes, but it seems that is still not quite correct...
 
```{r}
roster %>% 
  ggplot(aes(reorder(age_group, weight_clean), weight_clean, fill = sex)) +geom_boxplot()
```
 

```{r}

roster %>% filter(age_y>6 & age_y <15 ) %>% 
  mutate(bmi = weight_clean/((height_clean/100)^2)) %>% 
 # filter(bmi > 40) %>% 
#  select(hhid_unique, lineNum, age_y, age_m, sex, weight_kg, height_cm, height_clean, weight_clean, bmi ) #%>% View()
  ggplot(aes(as.factor(school), bmi, colour =as.factor(school_feed))) + geom_boxplot()

```


```{r}

# Calculating total months

roster$total_months <- ifelse(!is.na(roster$age_m), roster$age_m +(roster$age_y*12), roster$age_y*12)

test <- with(
  roster,
  anthro_zscores(
    sex = sex, age = total_months, is_age_in_month = TRUE, 
    weight = weight_kg, lenhei = height_cm
  )
)


test$id_unique <- roster$id_unique
names(test)

test %>% relocate(id_unique, .before = "clenhei") %>% 
  filter(!is.na(flen)) %>% 
  left_join(., roster %>% select(age_m, age_y, age_group, height_cm, weight_kg, hhid_unique, id_unique)) %>% 
  ggplot(aes(height_cm, fill = as.factor(flen))) + geom_histogram() +
  facet_wrap(~age_group)
  

test %>% relocate(id_unique, .before = "clenhei") %>% 
  filter(!is.na(flen)) %>% 
  left_join(., roster %>% select(age_m, age_y, age_group, height_cm, weight_kg, hhid_unique, id_unique)) %>% filter(flen == "1")
  
```

## Household data


```{r}


grep("count", labelled::var_label(hh), ignore.case = TRUE, value = TRUE)

unique(hh$county)

names(hh)

```

### F&D Domain: apparent intakes


```{r}

# Indicators to be plotted (e.g. Energy)
unique(data$Indicator)

# Defining the three different palettes
palette1 <- c("#edf8fb",  "#bfd3e6",  "#9ebcda",  "#8c96c6",  "#8c6bb1",  "#88419d",  "#6e016b")
palette2 <- c("#edf8fb",  "#ccece6",  "#99d8c9",  "#66c2a4",  "#41ae76",  "#238b45",  "#005824")
palette3 <- c("#f0f9e8",  "#ccebc5",  "#a8ddb5",  "#7bccc4",  "#4eb3d3",  "#2b8cbe",  "#08589e")

palletiis <- list(palette1, palette2, palette3)

#Storing the plots
maps <- list()

# Loop for generating the plots
for(i in 1:length(unique(data$Indicator))){
  
component <- unique(data$Indicator)[i]
component_title <- gsub("retinol activity equivalents", "RAE", unique(data$Indicator)[i])

maps[[i]] <- data %>% 
   left_join(., ken_admin2, by = c("Geographic.Level" = "county_name")) %>% 
  # filter(is.na(geometry))
  # class
  filter(!is.na(CNTNAME3) & Indicator %in% component & Element == "Average") %>% 
  st_as_sf() %>% 
  tm_shape() +
  tm_polygons(fill = "Value",
               fill.scale = tm_scale_intervals(values = palletiis[[i]]),
              fill_alpha = 0.5, 
                fill.legend =  tm_legend(title = component_title)) +
  tm_credits("Integrated Household Budget Survey, September 2015 - August 2016. Data from FAO F&D Domain", position = tm_pos_out("center", "bottom"))
}



```

```{r}

crop_map <- names(crop)[8:49]

# No palm oil cultivation in KEN
crop_var <- crop_map[3]
crop_name <- crop_names$crop_name[crop_names$crop_short %in% gsub("_a", "", crop_var)]

maps[[1]] +
 tm_shape(crop %>% filter(!!sym(crop_var) >0)) +
  tm_symbols( fill = crop_var, col = crop_var,  size = 0.6, fill_alpha = 0.6,
              fill.scale = tm_scale_continuous(values = palette5), 
              col.scale = tm_scale_continuous(values =  palette5), 
              fill.legend = tm_legend(paste0(crop_name, " (kg/ha)")),
              col.legend = tm_legend(show = FALSE))

```



## Kenya Countinous Household Survey programme 2022

```{r}


ken_admin2 <- ken_admin2 %>%
  mutate(county_name = stringr::str_to_title(NAME2_), 
         county_name = case_when(
  county_name == "E. Marakwet" ~ "Elgeyo Marakwet", 
  county_name == "Homa_bay" ~ "Homa Bay", 
  county_name == "Muranga" ~ "Murang'a", 
  county_name == "Nairobi" ~ "Nairobi", 
  county_name == "Taita Taveta" ~ "Taita Taveta", 
  county_name == "Nithi" ~ "Tharaka Nithi", 
  county_name == "Trans-Nzoia" ~ "Trans Nzoia", 
  .default = county_name))


# Indicators to be plotted (e.g. Energy)
unique(data$Indicator)

# Defining the three different palettes
palette1 <- c("#edf8fb",  "#bfd3e6",  "#9ebcda",  "#8c96c6",  "#8c6bb1",  "#88419d",  "#6e016b")
palette2 <- c("#edf8fb",  "#ccece6",  "#99d8c9",  "#66c2a4",  "#41ae76",  "#238b45",  "#005824")
palette3 <- c("#f0f9e8",  "#ccebc5",  "#a8ddb5",  "#7bccc4",  "#4eb3d3",  "#2b8cbe",  "#08589e")

palletiis <- list(palette1, palette2, palette3)

#Storing the plots
maps <- list()

# Loop for generating the plots
for(i in 1:length(unique(data$Indicator))){
  
component <- unique(data$Indicator)[i]
component_title <- gsub("retinol activity equivalents", "RAE", unique(data$Indicator)[i])

#nutrient_sace %>%
  survey_design %>% group_by(county_name) %>% 
 # group_by(!!sym(var)) %>% 
  summarise(across(starts_with("ame"),
                          ~srvyr::survey_quantile(.x, c(0.25, 0.5, 0.75)))) %>% 
  select(-ends_with("se")) %>%
   left_join(., ken_admin2, by = c("county_name")) %>% 
  # filter(is.na(geometry))
  # class
#  filter(!is.na(CNTNAME3) & Indicator %in% component & Element == "Average") %>% 
  st_as_sf() %>% 
  tm_shape() +
  tm_polygons(fill = "ame_cons_energy_kcal_q50",
               fill.scale = tm_scale_intervals(values = palette1),
              fill_alpha = 0.5
              #  fill.legend =  tm_legend(title = component_title)
              ) +
  tm_credits("Based on Kenya Countinous Household Survey programme 2022.", position = tm_pos_out("center", "bottom"))
 
}


```

